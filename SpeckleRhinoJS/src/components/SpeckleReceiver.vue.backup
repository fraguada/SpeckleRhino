<template>
<div>
  <md-card class="receiver paddedcard">
    <md-progress md-indeterminate v-show='showProgressBar'></md-progress>
    <md-progress :progress='objLoadProgress' v-show='objLoadProgress < 100 '></md-progress>
    <md-card-header class='line-height-30'>
       <span class='line-height-30'>
        <md-button class='md-icon-button md-dense' @click.native='expanded = ! expanded'>
          <md-icon>{{ expanded ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}</md-icon>
        </md-button>{{ spkreceiver.name }} 
      </span>
      <span class='md-caption line-height-30'><code style="user-select:all">{{ spkreceiver.streamId }}</code></span>
    </md-card-header>
    <div v-show='expanded'>
      <md-card-content>
        <!-- <speckle-receiver-layer v-for='layer in layers' :key='layer.guid' :spklayer='layer' :streamid='spkreceiver.streamId'></speckle-receiver-layer> -->
        <div v-for='layer in spkreceiver.layers'>{{layer.guid}}</div>
      </md-card-content>
    </div>
    <!-- </md-card-expand> -->
  </md-card>
</div>
</template>

<script>
import axios                      from 'axios'
import ReceiverClient             from '../receiver/SpeckleReceiver'

import SpeckleReceiverLayer       from './SpeckleReceiverLayer.vue'


export default {
  name: 'SpeckleReceiver',
  components: {
    SpeckleReceiverLayer
  },
  props: ['spkreceiver'],
  computed: {
    layers() {
      return this.spkreceiver.layers
    }
  },
  data () {
    return {
      showProgressBar: true,
      objLoadProgress: 100,
      objectsLength: 1,
      showError: true,
      error: 'No errors.',
      name:'loading...',
      expanded: true
    }
  },
  methods: {
    receiverError( err ) {
      this.error = err
    },
    receiverReady( name, layers, objects, history, layerMaterials ) {
      this.showProgressBar = false
      this.objLoadProgress = 0
      let payload = { streamId: this.spkreceiver.streamId, name: name, layers: layers, objects: objects, layerMaterials: layerMaterials }
      this.$store.commit( 'INIT_RECEIVER_DATA',  { payload } )
    },
    liveUpdate( name, layers, objects, objectProperties ) {
      this.showProgressBar = false
      this.objLoadProgress = 0
      this.objectsLength = objects.length
      this.name = name

      let payload = { streamId: this.spkreceiver.streamId, name: name, layers: layers, objects: objects }
      this.$store.commit( 'SET_RECEIVER_DATA',  { payload } )

      this.mySpkReceiver.getObjects( ( objs ) => {
        if( typeof cefCustomObject != 'undefined' ) 
          cefCustomObject.liveUpdate( this.spkreceiver.streamId, JSON.stringify( objs ), JSON.stringify( objectProperties ) )
      })
    }, 
    metadataUpdate( name, layers ) {
      let payload = { streamId: this.spkreceiver.streamId, name: name, layers: layers }
      this.$store.commit( 'SET_RECEIVER_METADATA',  { payload } )
      console.log( payload )
    },
    historyUpdate( ) {
      // todo
    },
    objLoadProgressEv( loaded ) {
      this.objLoadProgress = (loaded+1) / this.objectsLength * 100
    }
  },
  mounted() {
    console.log("I WAS CREATED MUHAHAHAHAH")
    this.mySpkReceiver = new ReceiverClient({
      serverUrl: this.spkreceiver.serverUrl,
      streamId: this.spkreceiver.streamId,
      token: this.spkreceiver.token,
      layers: []
    })

    this.mySpkReceiver.on( 'error', this.receiverError )
    this.mySpkReceiver.on( 'ready', this.receiverReady )
    this.mySpkReceiver.on( 'live-update', this.liveUpdate )
    this.mySpkReceiver.on( 'metadata-update', this.metadataUpdate )
    this.mySpkReceiver.on( 'history-update', this.historyUpdate )
    this.mySpkReceiver.on( 'object-load-progress', this.objLoadProgressEv ) 
  }
}
</script>

<style>
.receiver {
  margin-bottom: 10px;
}
.line-height-30{
  line-height: 35px;
}
</style>
